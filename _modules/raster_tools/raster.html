

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>raster_tools.raster &#8212; raster_tools 0.9.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/raster_tools/raster';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">raster_tools 0.9.2 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../reference/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/top_level.html">Top Level Functions</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.html">raster_tools.Raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.open_dataset.html">raster_tools.open_dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.band_concat.html">raster_tools.band_concat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.constant_raster.html">raster_tools.constant_raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.empty_like.html">raster_tools.empty_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.full_like.html">raster_tools.full_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.ones_like.html">raster_tools.ones_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.random_raster.html">raster_tools.random_raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.zeros_like.html">raster_tools.zeros_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.reclassify.html">raster_tools.reclassify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.remap_range.html">raster_tools.remap_range</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.html">raster_tools.Vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.count_layer_features.html">raster_tools.count_layer_features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.list_layers.html">raster_tools.list_layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.open_vectors.html">raster_tools.open_vectors</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/raster.html">Raster Objects</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.html">raster_tools.Raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.dtype.html">raster_tools.Raster.dtype</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.shape.html">raster_tools.Raster.shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.nbands.html">raster_tools.Raster.nbands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.null_value.html">raster_tools.Raster.null_value</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.values.html">raster_tools.Raster.values</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.data.html">raster_tools.Raster.data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.xdata.html">raster_tools.Raster.xdata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.mask.html">raster_tools.Raster.mask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.xmask.html">raster_tools.Raster.xmask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.x.html">raster_tools.Raster.x</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.y.html">raster_tools.Raster.y</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.crs.html">raster_tools.Raster.crs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.affine.html">raster_tools.Raster.affine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.resolution.html">raster_tools.Raster.resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.bounds.html">raster_tools.Raster.bounds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.bandwise.html">raster_tools.Raster.bandwise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.pxrs.html">raster_tools.Raster.pxrs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.xrs.html">raster_tools.Raster.xrs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.round.html">raster_tools.Raster.round</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.all.html">raster_tools.Raster.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.any.html">raster_tools.Raster.any</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.max.html">raster_tools.Raster.max</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.mean.html">raster_tools.Raster.mean</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.min.html">raster_tools.Raster.min</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.prod.html">raster_tools.Raster.prod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.std.html">raster_tools.Raster.std</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.sum.html">raster_tools.Raster.sum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.var.html">raster_tools.Raster.var</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.chunk.html">raster_tools.Raster.chunk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.get_bands.html">raster_tools.Raster.get_bands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.get_chunk_rasters.html">raster_tools.Raster.get_chunk_rasters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.to_quadrants.html">raster_tools.Raster.to_quadrants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.burn_mask.html">raster_tools.Raster.burn_mask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.reclassify.html">raster_tools.Raster.reclassify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.replace_null.html">raster_tools.Raster.replace_null</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.remap_range.html">raster_tools.Raster.remap_range</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.set_null_value.html">raster_tools.Raster.set_null_value</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.set_null.html">raster_tools.Raster.set_null</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.to_null_mask.html">raster_tools.Raster.to_null_mask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.where.html">raster_tools.Raster.where</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.astype.html">raster_tools.Raster.astype</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.copy.html">raster_tools.Raster.copy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.to_dataset.html">raster_tools.Raster.to_dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.to_numpy.html">raster_tools.Raster.to_numpy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.to_vector.html">raster_tools.Raster.to_vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.index.html">raster_tools.Raster.index</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.set_crs.html">raster_tools.Raster.set_crs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.xy.html">raster_tools.Raster.xy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.reproject.html">raster_tools.Raster.reproject</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.close.html">raster_tools.Raster.close</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.eval.html">raster_tools.Raster.eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.load.html">raster_tools.Raster.load</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.save.html">raster_tools.Raster.save</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.explore.html">raster_tools.Raster.explore</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.plot.html">raster_tools.Raster.plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.get_chunk_bounding_boxes.html">raster_tools.Raster.get_chunk_bounding_boxes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.get_chunked_coords.html">raster_tools.Raster.get_chunked_coords</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Raster.model_predict.html">raster_tools.Raster.model_predict</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/vector.html">Vector Objects</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.open_vectors.html">raster_tools.open_vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.bounds.html">raster_tools.Vector.bounds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.crs.html">raster_tools.Vector.crs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.data.html">raster_tools.Vector.data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.field_dtypes.html">raster_tools.Vector.field_dtypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.field_names.html">raster_tools.Vector.field_names</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.field_schema.html">raster_tools.Vector.field_schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.geometry.html">raster_tools.Vector.geometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.shape.html">raster_tools.Vector.shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.size.html">raster_tools.Vector.size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.table.html">raster_tools.Vector.table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.tasks.html">raster_tools.Vector.tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.eval.html">raster_tools.Vector.eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.save.html">raster_tools.Vector.save</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_crs.html">raster_tools.Vector.to_crs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_dask.html">raster_tools.Vector.to_dask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_dataframe.html">raster_tools.Vector.to_dataframe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_lazy.html">raster_tools.Vector.to_lazy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_raster.html">raster_tools.Vector.to_raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.to_shapely.html">raster_tools.Vector.to_shapely</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.cast_field.html">raster_tools.Vector.cast_field</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.buffer.html">raster_tools.Vector.buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.Vector.simplify.html">raster_tools.Vector.simplify</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/distance.html">Distance Analysis</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.cost_distance_analysis.html">raster_tools.distance.cost_distance_analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.cda_allocation.html">raster_tools.distance.cda_allocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.cda_cost_distance.html">raster_tools.distance.cda_cost_distance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.cda_traceback.html">raster_tools.distance.cda_traceback</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.proximity_analysis.html">raster_tools.distance.proximity_analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.pa_allocation.html">raster_tools.distance.pa_allocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.pa_direction.html">raster_tools.distance.pa_direction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.distance.pa_proximity.html">raster_tools.distance.pa_proximity</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/clipping.html">Clipping Operations</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.clipping.clip.html">raster_tools.clipping.clip</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.clipping.clip_box.html">raster_tools.clipping.clip_box</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.clipping.envelope.html">raster_tools.clipping.envelope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.clipping.erase.html">raster_tools.clipping.erase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.clipping.mask.html">raster_tools.clipping.mask</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/focal.html">Focal Operations</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.focal.focal.html">raster_tools.focal.focal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.focal.correlate.html">raster_tools.focal.correlate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.focal.convolve.html">raster_tools.focal.convolve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.focal.check_kernel.html">raster_tools.focal.check_kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.focal.get_focal_window.html">raster_tools.focal.get_focal_window</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/general.html">General Purpose Operations</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.ModelPredictAdaptor.html">raster_tools.general.ModelPredictAdaptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.aggregate.html">raster_tools.general.aggregate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.band_concat.html">raster_tools.general.band_concat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.dilate.html">raster_tools.general.dilate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.erode.html">raster_tools.general.erode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.local_stats.html">raster_tools.general.local_stats</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.model_predict_raster.html">raster_tools.general.model_predict_raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.model_predict_vector.html">raster_tools.general.model_predict_vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.reclassify.html">raster_tools.general.reclassify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.regions.html">raster_tools.general.regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.remap_range.html">raster_tools.general.remap_range</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.general.where.html">raster_tools.general.where</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/rasterize.html">Rasterize</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.rasterize.rasterize.html">raster_tools.rasterize.rasterize</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/surface.html">Surface Operations</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.aspect.html">raster_tools.surface.aspect</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.curvature.html">raster_tools.surface.curvature</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.easting.html">raster_tools.surface.easting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.hillshade.html">raster_tools.surface.hillshade</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.northing.html">raster_tools.surface.northing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.slope.html">raster_tools.surface.slope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.surface_area_3d.html">raster_tools.surface.surface_area_3d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.surface.tpi.html">raster_tools.surface.tpi</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/warp.html">Warp Operations</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.warp.reproject.html">raster_tools.warp.reproject</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../reference/zonal.html">Zonal Operations</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.zonal.extract_points_eager.html">raster_tools.zonal.extract_points_eager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/generated/raster_tools.zonal.zonal_stats.html">raster_tools.zonal.zonal_stats</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">raster_tools</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../raster_tools.html">raster_tools package</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../raster_tools.distance.html">raster_tools.distance package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/UM-RMRS/raster_tools">GitHub</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for raster_tools.raster</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">odc.geo.xr</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span> <span class="nn">rasterio</span> <span class="k">as</span> <span class="nn">rio</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">odc.geo.geobox</span> <span class="kn">import</span> <span class="n">GeoBox</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>

<span class="kn">from</span> <span class="nn">raster_tools.dask_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">chunks_to_array_locations</span><span class="p">,</span>
    <span class="n">dask_nanmax</span><span class="p">,</span>
    <span class="n">dask_nanmin</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">raster_tools.dtypes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BOOL</span><span class="p">,</span>
    <span class="n">DTYPE_INPUT_TO_DTYPE</span><span class="p">,</span>
    <span class="n">F16</span><span class="p">,</span>
    <span class="n">F32</span><span class="p">,</span>
    <span class="n">F64</span><span class="p">,</span>
    <span class="n">I8</span><span class="p">,</span>
    <span class="n">I16</span><span class="p">,</span>
    <span class="n">I32</span><span class="p">,</span>
    <span class="n">I64</span><span class="p">,</span>
    <span class="n">U8</span><span class="p">,</span>
    <span class="n">U16</span><span class="p">,</span>
    <span class="n">U32</span><span class="p">,</span>
    <span class="n">U64</span><span class="p">,</span>
    <span class="n">is_bool</span><span class="p">,</span>
    <span class="n">is_float</span><span class="p">,</span>
    <span class="n">is_int</span><span class="p">,</span>
    <span class="n">is_scalar</span><span class="p">,</span>
    <span class="n">is_str</span><span class="p">,</span>
    <span class="n">promote_dtype_to_float</span><span class="p">,</span>
    <span class="n">should_promote_to_fit</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">raster_tools.exceptions</span> <span class="kn">import</span> <span class="n">RasterDataError</span><span class="p">,</span> <span class="n">RasterIOError</span>
<span class="kn">from</span> <span class="nn">raster_tools.masking</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_default_null_value</span><span class="p">,</span>
    <span class="n">reconcile_nullvalue_with_dtype</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">raster_tools.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">can_broadcast</span><span class="p">,</span>
    <span class="n">is_strictly_decreasing</span><span class="p">,</span>
    <span class="n">is_strictly_increasing</span><span class="p">,</span>
    <span class="n">merge_masks</span><span class="p">,</span>
    <span class="n">to_chunk_dict</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IO_UNDERSTOOD_TYPES</span><span class="p">,</span>
    <span class="n">chunk</span><span class="p">,</span>
    <span class="n">is_batch_file</span><span class="p">,</span>
    <span class="n">open_raster_from_path_or_url</span><span class="p">,</span>
    <span class="n">write_raster</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_REDUCTION_FUNCS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="s2">&quot;any&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">_NAN_REDUCTION_FUNCS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prod&quot;</span><span class="p">,</span>
    <span class="s2">&quot;std&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;var&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">_REDUCTION_DOCSTRING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    Reduce the raster to a single dask value by applying `</span><span class="si">{}</span><span class="s2">` across all bands.</span>

<span class="s2">    All arguments are ignored.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_inject_reductions</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">pass</span>
    <span class="n">funcs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_REDUCTION_FUNCS</span><span class="p">]</span>
    <span class="n">funcs</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s2">&quot;nan&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_NAN_REDUCTION_FUNCS</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build_reduce_method</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_REDUCTION_DOCSTRING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>


<span class="n">_MIN_MAX_FUNC_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">:</span> <span class="n">dask_nanmax</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">:</span> <span class="n">dask_nanmax</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">:</span> <span class="n">dask_nanmin</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">:</span> <span class="n">dask_nanmin</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">_ReductionsMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This mixin class adds reduction methods like `all`, `sum`, etc to the</span>
<span class="sd">    Raster class. Having these methods also allows numpy reduction functions to</span>
<span class="sd">    use them for dynamic dispatch. So `np.sum(raster)` will call the class&#39;</span>
<span class="sd">    `sum` method. All reductions return dask results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_inject_reductions</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_reduce_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_MIN_MAX_FUNC_MAP</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">_MIN_MAX_FUNC_MAP</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Take args and kwargs to stay compatible with numpy</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">method</span>


<span class="k">def</span> <span class="nf">_normalize_ufunc_other</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">this</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)):</span>
        <span class="c1"># allow only if broadcastable</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dask arrays must have known chunks&quot;</span><span class="p">)</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">can_broadcast</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Raster could not broadcast together with array of shape&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">this</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; Did you mean to use Raster.bandwise?&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Raster</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">other</span>


<span class="k">def</span> <span class="nf">_apply_ufunc</span><span class="p">(</span><span class="n">ufunc</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">left</span> <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">this</span> <span class="k">else</span> <span class="n">right</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="n">masked</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;_masked&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">ufunc_args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;xdata&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">out_crs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">this</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_crs</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">crs</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Raster</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_crs</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">crs</span>

    <span class="n">ufname</span> <span class="o">=</span> <span class="n">ufunc</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="n">ufname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bitwise&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Bitwise operations are not compatible with float dtypes. You may&quot;</span>
            <span class="s2">&quot; want to convert one or more inputs to a boolean or integer dtype&quot;</span>
            <span class="s2">&quot; (e.g. &#39;raster &gt; 0&#39; or &#39;raster.astype(int)&#39;).&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">ufname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;shift&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;right_shift and left_shift operations are not compatible with&quot;</span>
            <span class="s2">&quot; float dtypes. You may want to convert one or more inputs to an&quot;</span>
            <span class="s2">&quot; integer dtype (e.g. &#39;raster.astype(int)&#39;).&quot;</span>
        <span class="p">)</span>

    <span class="n">xr_out</span> <span class="o">=</span> <span class="n">ufunc</span><span class="p">(</span><span class="o">*</span><span class="n">ufunc_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">multi_out</span> <span class="o">=</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">nout</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">get_mask_from_data</span><span class="p">(</span><span class="n">xr_out</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_out</span><span class="p">:</span>
            <span class="n">xmask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">xr_out</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">xr_out</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">xr_out</span> <span class="o">=</span> <span class="n">xr_out</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xr_out</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">xr_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">xr_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>
            <span class="p">)</span>
            <span class="n">xr_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xr_out</span><span class="p">]</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_raster_ds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xr_out</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">merge_masks</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">xmask</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Raster</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_out</span><span class="p">:</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="n">get_default_null_value</span><span class="p">(</span><span class="n">xr_out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">xr_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">xr_out</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xr_out</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_default_null_value</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xr_out</span><span class="p">]</span>
            <span class="n">xr_out</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">nv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xr_out</span><span class="p">,</span> <span class="n">nvs</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_raster_ds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xr_out</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">out_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">multi_out</span><span class="p">:</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">out_crs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">out_crs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># &quot;Inplace&quot;</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds_out</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds_out</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rs_outs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Raster</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rs_outs</span>


<span class="n">_UNARY_UFUNCS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_UNSUPPORED_UFUNCS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_RasterBase</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mixins</span><span class="o">.</span><span class="n">NDArrayOperatorsMixin</span><span class="p">,</span> <span class="n">_ReductionsMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class implements methods for handling numpy ufuncs.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">_HANDLED_TYPES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">,</span>
        <span class="nb">tuple</span><span class="p">,</span>
        <span class="nb">range</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Higher than xarray objects</span>
    <span class="n">__array_priority__</span> <span class="o">=</span> <span class="mi">70</span>

    <span class="k">def</span> <span class="nf">__array_ufunc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ufunc</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HANDLED_TYPES</span> <span class="o">+</span> <span class="p">(</span><span class="n">_RasterBase</span><span class="p">,)):</span>
                <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">if</span> <span class="n">ufunc</span> <span class="ow">in</span> <span class="n">_UNSUPPORED_UFUNCS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raster objects are not supported for ufunc: &#39;</span><span class="si">{</span><span class="n">ufunc</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Raster does not support gufuncs&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;__call__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> for ufunc </span><span class="si">{</span><span class="n">ufunc</span><span class="si">}</span><span class="s2"> is not implemented on Raster &quot;</span>
                <span class="s2">&quot;objects.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">nin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Too many inputs for ufunc:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; inputs=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">, ufunc=</span><span class="si">{</span><span class="n">ufunc</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;out&#39; keyword is only supported for inplace &quot;</span>
                    <span class="s2">&quot;operations, not operations with multiple outputs.&quot;</span>
                <span class="p">)</span>
            <span class="p">(</span><span class="n">out</span><span class="p">,)</span> <span class="o">=</span> <span class="n">out</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;out&#39; must be the raster being operated on.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">nin</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">left</span> <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span> <span class="k">else</span> <span class="n">right</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_normalize_ufunc_other</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">_apply_ufunc</span><span class="p">(</span><span class="n">ufunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">__array__</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_normalize_bandwise_other</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dask arrays must have known chunks&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">can_broadcast</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Operands can be broadcast together. A bandwise operation is not&quot;</span>
            <span class="s2">&quot; needed here.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">target_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Map a list/array of values that has same length as # of bands to</span>
        <span class="c1"># each band</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;Received array with incompatible shape in bandwise operation: &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="BandwiseOperationAdapter"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.BandwiseOperationAdapter">[docs]</a><span class="k">class</span> <span class="nc">BandwiseOperationAdapter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mixins</span><span class="o">.</span><span class="n">NDArrayOperatorsMixin</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_raster&quot;</span><span class="p">,)</span>

    <span class="n">_HANDLED_TYPES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">,</span>
        <span class="nb">tuple</span><span class="p">,</span>
        <span class="nb">range</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Higher than xarray objects</span>
    <span class="n">__array_priority__</span> <span class="o">=</span> <span class="mi">70</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raster</span> <span class="o">=</span> <span class="n">raster</span>

    <span class="k">def</span> <span class="nf">__array_ufunc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ufunc</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_HANDLED_TYPES</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">Raster</span><span class="p">,</span>
                    <span class="n">BandwiseOperationAdapter</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Bandwise operations are binary and require 2 inputs. Only&quot;</span>
                <span class="s2">&quot; one given.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Bandwise operations are binary and require 2 inputs.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> given.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ufunc</span> <span class="ow">in</span> <span class="n">_UNSUPPORED_UFUNCS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;The given ufunc is not supported for bandwise operations:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">ufunc</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Raster does not support gufuncs&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;__call__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> for ufunc </span><span class="si">{</span><span class="n">ufunc</span><span class="si">}</span><span class="s2"> is not implemented for bandwise &quot;</span>
                <span class="s2">&quot; operations.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">nin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Too many inputs for ufunc:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; inputs=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">, ufunc=</span><span class="si">{</span><span class="n">ufunc</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;out&#39; keyword is not supported for bandwise operations&quot;</span>
            <span class="p">)</span>

        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">left</span> <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span> <span class="k">else</span> <span class="n">right</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_normalize_bandwise_other</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raster</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raster</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">other</span>
            <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raster</span>

        <span class="k">return</span> <span class="n">ufunc</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="xr_where_with_meta"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.xr_where_with_meta">[docs]</a><span class="k">def</span> <span class="nf">xr_where_with_meta</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_mask_from_data"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.get_mask_from_data">[docs]</a><span class="k">def</span> <span class="nf">get_mask_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">da</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">xr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span> <span class="o">==</span> <span class="n">nv</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="normalize_data"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.normalize_data">[docs]</a><span class="k">def</span> <span class="nf">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">yx_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2d/3d np.ndarray or da.Array --&gt; 3D da.Array.</span>

<span class="sd">    This transforms the data array into the standard data format, which has the</span>
<span class="sd">    following properties:</span>

<span class="sd">    * 3D with band dimension first.</span>
<span class="sd">    * Is a dask array</span>
<span class="sd">    * Chunksize of 1 in the band dim.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    yx_chunks : tuple, optional</span>
<span class="sd">        Tuple of chunks for the y and x dimensions, in that order. The default</span>
<span class="sd">        is to leave the chunks as is in this dimension or to chunk with</span>
<span class="sd">        ``&quot;auto&quot;``, if `data` is a numpy array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : dask.array.Array</span>
<span class="sd">        The resulting dask array.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;data must be a numpy or dask array&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data must be 2d or 3d&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yx_chunks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">yx_chunks</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">yx_chunks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="normalize_xarray_data"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.normalize_xarray_data">[docs]</a><span class="k">def</span> <span class="nf">normalize_xarray_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the DataArray to the standard raster DataArray format.</span>

<span class="sd">    A standard raster DataArray has the following:</span>

<span class="sd">    * 3 dimensions in this order: ``(&quot;band&quot;, &quot;y&quot;, &quot;x&quot;)``</span>
<span class="sd">    * The band dim coordinates starts at one. ex:  ``[1, 2, ...]``</span>
<span class="sd">    * The x dim coordinates are always increasing.</span>
<span class="sd">    * The y dim coordinates are always decreasing.</span>
<span class="sd">    * The CRS is encoded at `obj.rio.crs`</span>
<span class="sd">    * The nodata/null value is encoded at `obj.rio.nodata`</span>
<span class="sd">    * The data within the DataArray is a dask array.</span>
<span class="sd">    * The dask chunks have size 1 in the band dim.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">chunk</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid shape. xarray.DataArray objects must have 2D or 3D &quot;</span>
            <span class="s2">&quot;shapes.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Add band dim</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">if</span> <span class="s2">&quot;lon&quot;</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">})</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">if</span> <span class="s2">&quot;lat&quot;</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">})</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
        <span class="c1"># No easy way to figure out how best to transpose based on dim names so</span>
        <span class="c1"># just assume the order is valid and rename.</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">d</span><span class="p">:</span> <span class="n">new_d</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">new_d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">new_d</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">xdata</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">xdata</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">band</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid coordinates on xarray.DataArray object:</span><span class="se">\n</span><span class="si">{xdata!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">x_dim</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">y_dim</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_spatial_dims</span><span class="p">(</span><span class="n">x_dim</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y_dim</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xdata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">})</span>
    <span class="c1"># Make sure that x is always increasing and y is always decreasing. xarray</span>
    <span class="c1"># will auto align rasters but when a raster is converted to a numpy or dask</span>
    <span class="c1"># array, the data may not be aligned. This ensures that rasters converted</span>
    <span class="c1"># to non-georeferenecd formats will be oriented the same.</span>
    <span class="k">if</span> <span class="n">is_strictly_decreasing</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">is_strictly_increasing</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># This MUST BE DONE. Need to recompute and write the transform so that</span>
    <span class="c1"># rechunking to (N,1,1) doesn&#39;t cause the transform to be dropped. This</span>
    <span class="c1"># only happens for hard to reproduce and test edge-cases far down the</span>
    <span class="c1"># pipeline.</span>
    <span class="c1"># TODO: Find test to check for just this. For right now,</span>
    <span class="c1"># tests/test_raster.py::test_to_points catches it.</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_transform</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xdata</span></div>


<div class="viewcode-block" id="data_to_xr_raster"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_xr_raster">[docs]</a><span class="k">def</span> <span class="nf">data_to_xr_raster</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a standard raster DataArray from a data array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    x : list, np.ndarra, optional</span>
<span class="sd">        The x coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    y : list, np.ndarra, optional</span>
<span class="sd">        The y coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    affine : affine.Affine, optional</span>
<span class="sd">        If ``None``, the affine matrix is created using `x` and `y`. If</span>
<span class="sd">        `affine` is ``None`` and `x` and `y` are not specified, default affine</span>
<span class="sd">        matrix of:</span>
<span class="sd">        ::</span>

<span class="sd">            | 1.0 0.0 0.0 |</span>
<span class="sd">            | 0.0 1.0   N |</span>

<span class="sd">        where N is the size of the y dim.</span>
<span class="sd">    crs : int, str, rasterio.CRS, optional</span>
<span class="sd">        The CRS to use for the result. The default is no CRS.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.DataArray</span>
<span class="sd">        The resulting raster DataArray.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster_ds,</span>
<span class="sd">    data_to_xr_raster_ds_like, data_to_xr_raster_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">affine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Add 0.5 offset to move coords to center of cell</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">xi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify both x and y or neither.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;x and y must be numpy arrays&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y do not match data shape&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_build_x_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_build_y_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># The band dimension needs to start at 1 to match raster conventions</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_spatial_dims</span><span class="p">(</span><span class="n">y_dim</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">x_dim</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normalize_xarray_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span></div>


<div class="viewcode-block" id="data_to_xr_raster_like"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_xr_raster_like">[docs]</a><span class="k">def</span> <span class="nf">data_to_xr_raster_like</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">xlike</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_band_dim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">match_chunks</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a standard raster DataArray based on a template DataArray.</span>

<span class="sd">    The CRS and x/y information are pulled from `xlike`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    xlike : xarray.DataArray</span>
<span class="sd">        The template to pull geospatial information from.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>
<span class="sd">    match_band_dim : bool, optional</span>
<span class="sd">        If `data` has only 1 band, this will stack `data` to match the number</span>
<span class="sd">        of bands in `xlike`. The default is to not match the number of bands.</span>
<span class="sd">    match_chunks : bool, optional</span>
<span class="sd">        If ``True``, the chunks of the output will match the chunks in `xlike`.</span>
<span class="sd">        The default is ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.DataArray</span>
<span class="sd">        The resulting raster DataArray matcing `xlike`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds, data_to_xr_raster_ds_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yx_chunks</span> <span class="o">=</span> <span class="n">xlike</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">match_chunks</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">yx_chunks</span><span class="o">=</span><span class="n">yx_chunks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">xlike</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data x/y dims did not match xlike&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">match_band_dim</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xlike</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_to_xr_raster</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="make_raster_ds"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.make_raster_ds">[docs]</a><span class="k">def</span> <span class="nf">make_raster_ds</span><span class="p">(</span><span class="n">raster_dataarray</span><span class="p">,</span> <span class="n">mask_dataarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes data and mask DataArrays and produces a raster Dataset with the data</span>
<span class="sd">    in the data variable &quot;raster&quot; and the mask in the &quot;mask&quot; data variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;raster&quot;</span><span class="p">:</span> <span class="n">raster_dataarray</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_dataarray</span><span class="p">})</span></div>


<div class="viewcode-block" id="data_to_xr_raster_ds"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_xr_raster_ds">[docs]</a><span class="k">def</span> <span class="nf">data_to_xr_raster_ds</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a standard raster Dataset from a data array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    mask : np.ndarray, dask.array.Array</span>
<span class="sd">        A boolean mask array. The default is to generate a mask from the data</span>
<span class="sd">        using `nv`.</span>
<span class="sd">    x : list, np.ndarra, optional</span>
<span class="sd">        The x coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    y : list, np.ndarra, optional</span>
<span class="sd">        The y coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    affine : affine.Affine, optional</span>
<span class="sd">        If ``None``, the affine matrix is created using `x` and `y`. If</span>
<span class="sd">        `affine` is ``None`` and `x` and `y` are not specified, default affine</span>
<span class="sd">        matrix of:</span>
<span class="sd">        ::</span>

<span class="sd">            | 1.0 0.0 0.0 |</span>
<span class="sd">            | 0.0 1.0   N |</span>

<span class="sd">        where N is the size of the y dim.</span>
<span class="sd">    crs : int, str, rasterio.CRS, optional</span>
<span class="sd">        The CRS to use for the result. The default is no CRS.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>
<span class="sd">    burn : bool, optional</span>
<span class="sd">        If ``True``, `mask` is used to &#39;burn&#39; the null value into the data</span>
<span class="sd">        array (e.g. `np.where(mask, nv, data)`). The default is ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.Dataset</span>
<span class="sd">        Theresulting raster Dataset object.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds_like, data_to_xr_raster_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">get_mask_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data and mask dimensions do not match&quot;</span><span class="p">)</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">get_default_null_value</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nv</span>
        <span class="k">if</span> <span class="n">burn</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">data_to_xr_raster</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">)</span>
    <span class="n">xmask</span> <span class="o">=</span> <span class="n">data_to_xr_raster</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span></div>


<div class="viewcode-block" id="data_to_xr_raster_ds_like"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_xr_raster_ds_like">[docs]</a><span class="k">def</span> <span class="nf">data_to_xr_raster_ds_like</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">xlike</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">match_chunks</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a standard raster Dataset using a template raster DataArray.</span>

<span class="sd">    The CRS and x/y information are pulled from `xlike`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    xlike : xarray.DataArray</span>
<span class="sd">        The template to pull geospatial information from.</span>
<span class="sd">    mask : np.ndarray, dask.array.Array</span>
<span class="sd">        A boolean mask array. The default is to generate a mask from the data</span>
<span class="sd">        using `nv`.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>
<span class="sd">    burn : bool, optional</span>
<span class="sd">        If ``True``, `mask` is used to &#39;burn&#39; the null value into the data</span>
<span class="sd">        array (e.g. `np.where(mask, nv, data)`). The default is ``False``.</span>
<span class="sd">    match_chunks : bool, optional</span>
<span class="sd">        If ``True``, the chunks of the output will match the chunks in `xlike`.</span>
<span class="sd">        The default is ``True``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.Dataset</span>
<span class="sd">        The resulting raster Dataset object matching `xlike`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds, data_to_xr_raster_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yx_chunks</span> <span class="o">=</span> <span class="n">xlike</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">match_chunks</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">yx_chunks</span><span class="o">=</span><span class="n">yx_chunks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">xlike</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data x/y dims did not match xlike&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="n">get_default_null_value</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">yx_chunks</span><span class="o">=</span><span class="n">yx_chunks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data and mask dimensions do not match&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_to_xr_raster_ds</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">xlike</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">,</span>
        <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="data_to_raster"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_raster">[docs]</a><span class="k">def</span> <span class="nf">data_to_raster</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Raster from a data array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    mask : np.ndarray, dask.array.Array</span>
<span class="sd">        A boolean mask array. The default is to generate a mask from the data</span>
<span class="sd">        using `nv`.</span>
<span class="sd">    x : list, np.ndarra, optional</span>
<span class="sd">        The x coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    y : list, np.ndarra, optional</span>
<span class="sd">        The y coordinate value. If `x` and `y` are not specified, `affine` is</span>
<span class="sd">        used to generate x and y coordinates.</span>
<span class="sd">    affine : affine.Affine, optional</span>
<span class="sd">        If ``None``, the affine matrix is created using `x` and `y`. If</span>
<span class="sd">        `affine` is ``None`` and `x` and `y` are not specified, default affine</span>
<span class="sd">        matrix of:</span>
<span class="sd">        ::</span>

<span class="sd">            | 1.0 0.0 0.0 |</span>
<span class="sd">            | 0.0 1.0   N |</span>

<span class="sd">        where N is the size of the y dim.</span>
<span class="sd">    crs : int, str, rasterio.CRS, optional</span>
<span class="sd">        The CRS to use for the result. The default is no CRS.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>
<span class="sd">    burn : bool, optional</span>
<span class="sd">        If ``True``, `mask` is used to &#39;burn&#39; the null value into the data</span>
<span class="sd">        array (e.g. `np.where(mask, nv, data)`). The default is ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : Raster</span>
<span class="sd">        The resulting Raster object.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster_like, data_to_xr_raster, data_to_xr_raster_ds,</span>
<span class="sd">    data_to_xr_raster_ds_like, data_to_xr_raster_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data_to_xr_raster_ds</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">,</span>
        <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="data_to_raster_like"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.data_to_raster_like">[docs]</a><span class="k">def</span> <span class="nf">data_to_raster_like</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">like</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">match_chunks</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Raster, based on a template Raster, from a data array.</span>

<span class="sd">    The CRS and x/y information are pulled from `xlike`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray, dask.array.Array</span>
<span class="sd">        The data array.</span>
<span class="sd">    like : xarray.DataArray, Raster</span>
<span class="sd">        The template to pull geospatial information from. Can be a DataArray or</span>
<span class="sd">        Raster.</span>
<span class="sd">    mask : np.ndarray, dask.array.Array</span>
<span class="sd">        A boolean mask array. The default is to generate a mask from the data</span>
<span class="sd">        using `nv`.</span>
<span class="sd">    nv : scalar, optional</span>
<span class="sd">        The nodata/null value to use. The default is no null value.</span>
<span class="sd">    burn : bool, optional</span>
<span class="sd">        If ``True``, `mask` is used to &#39;burn&#39; the null value into the data</span>
<span class="sd">        array (e.g. `np.where(mask, nv, data)`). The default is ``False``.</span>
<span class="sd">    match_chunks : bool, optional</span>
<span class="sd">        If ``True``, the chunks of the output will match the chunks in `xlike`.</span>
<span class="sd">        The default is ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : Raster</span>
<span class="sd">        The resulting raster matching `like`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_xr_raster, data_to_xr_raster_ds,</span>
<span class="sd">    data_to_xr_raster_ds_like, data_to_xr_raster_like, dataarray_to_raster,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">like</span><span class="p">,</span> <span class="n">Raster</span><span class="p">):</span>
        <span class="n">like</span> <span class="o">=</span> <span class="n">like</span><span class="o">.</span><span class="n">xdata</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data_to_xr_raster_ds_like</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">like</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">match_chunks</span><span class="o">=</span><span class="n">match_chunks</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="dataarray_to_xr_raster"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.dataarray_to_xr_raster">[docs]</a><span class="k">def</span> <span class="nf">dataarray_to_xr_raster</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform a DataArray object into standard raster DataArray.</span>

<span class="sd">    The CRS and null value are pulled from `xdata` using `rioxarray`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xdata : xarray.DataArray,</span>
<span class="sd">        The object to convert to a raster form.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.DataArray</span>
<span class="sd">        The resulting DataArray in standard raster format with dims: ``(&quot;band&quot;,</span>
<span class="sd">        &quot;y&quot;, &quot;x&quot;)`` and encoded CRS and null value.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds, data_to_xr_raster_ds_like, data_to_xr_raster_like,</span>
<span class="sd">    dataarray_to_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">normalize_xarray_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span></div>


<div class="viewcode-block" id="dataarray_to_xr_raster_ds"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.dataarray_to_xr_raster_ds">[docs]</a><span class="k">def</span> <span class="nf">dataarray_to_xr_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a raster Dataset object from a DataArray object.</span>

<span class="sd">    The null value is pulled from `xdata` using `rioxarray`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xdata : xarray.DataArray,</span>
<span class="sd">        The object to convert to a raster Dataset</span>
<span class="sd">    xmask : xarray.DataArray[bool], optional</span>
<span class="sd">        The matching mask to use with the `xdata` object when creating the</span>
<span class="sd">        raster Dataset. Must have boolean dtype. The default is to generate a</span>
<span class="sd">        mask from `xdata` based on the value returned by `xdata.rio.nodata`.</span>
<span class="sd">    crs : int, str, rasterio.CRS, optional</span>
<span class="sd">        The CRS to use when creating the result. The default is to take the CRS</span>
<span class="sd">        from `xdata`, if present.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : xarray.Dataset</span>
<span class="sd">        The resulting raster Dataset with two data variables: &quot;raster&quot; and</span>
<span class="sd">        &quot;mask&quot;.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds, data_to_xr_raster_ds_like, data_to_xr_raster_like,</span>
<span class="sd">    dataarray_to_raster, dataarray_to_xr_raster</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">dataarray_to_xr_raster</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xmask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">get_mask_from_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">dataarray_to_xr_raster</span><span class="p">(</span><span class="n">xmask</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="dataarray_to_raster"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.dataarray_to_raster">[docs]</a><span class="k">def</span> <span class="nf">dataarray_to_raster</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Raster from a DataArray object.</span>

<span class="sd">    The null value is pulled from `xdata` using `rioxarray`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xdata : xarray.DataArray</span>
<span class="sd">        The object to make a Raster from.</span>
<span class="sd">    xmask : xarray.DataArray, optional</span>
<span class="sd">        The matching mask to use with the `xdata` object when creating the</span>
<span class="sd">        raster Dataset. Must have boolean dtype. The default is to generate a</span>
<span class="sd">        mask from `xdata` based on the value returned by `xdata.rio.nodata`.</span>
<span class="sd">    crs : int, str, rasterio.CRS, optional</span>
<span class="sd">        The CRS to use when creating the result. The default is to take the CRS</span>
<span class="sd">        from `xdata`, if present.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    raster : Raster</span>
<span class="sd">        The resulting Raster.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    data_to_raster, data_to_raster_like, data_to_xr_raster,</span>
<span class="sd">    data_to_xr_raster_ds, data_to_xr_raster_ds_like, data_to_xr_raster_like,</span>
<span class="sd">    dataarray_to_xr_raster, dataarray_to_xr_raster_ds</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span>
        <span class="n">dataarray_to_xr_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="o">=</span><span class="n">xmask</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">),</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_array_input_to_raster_ds</span><span class="p">(</span><span class="n">ar</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
        <span class="n">has_nan</span> <span class="o">=</span> <span class="n">is_float</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">has_nan</span> <span class="o">=</span> <span class="n">is_float</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
    <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">has_nan</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data_to_xr_raster_ds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">)</span>

    <span class="c1"># Maintain compatibility</span>
    <span class="n">orig_nv</span> <span class="o">=</span> <span class="n">nv</span>
    <span class="n">nv</span> <span class="o">=</span> <span class="n">reconcile_nullvalue_with_dtype</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">orig_nv</span><span class="p">)</span> <span class="ow">or</span> <span class="n">orig_nv</span> <span class="o">!=</span> <span class="n">nv</span><span class="p">):</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;raster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr_where_with_meta</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">raster</span>
        <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span> <span class="nf">_try_to_get_null_value_xarray</span><span class="p">(</span><span class="n">xrs</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;_FillValue&quot;</span> <span class="ow">in</span> <span class="n">xrs</span><span class="o">.</span><span class="n">attrs</span>
        <span class="ow">and</span> <span class="n">xrs</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">xrs</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">xrs</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">encoded_nodata</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xrs</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">null</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">null</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">null</span>
    <span class="n">nv1</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
    <span class="n">nv2</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">encoded_nodata</span>
    <span class="c1"># All are None, return nan for float and None otherwise</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">nv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nv1</span><span class="p">,</span> <span class="n">nv2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">is_float</span><span class="p">(</span><span class="n">xrs</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xrs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xrs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># All are not None, return nv1</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">nv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nv1</span><span class="p">,</span> <span class="n">nv2</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">nv1</span>
    <span class="c1"># One is None and the other is not, return the valid null value</span>
    <span class="k">return</span> <span class="n">nv1</span> <span class="k">if</span> <span class="n">nv1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nv2</span>


<span class="k">def</span> <span class="nf">_dataarray_input_to_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
    <span class="n">nv</span> <span class="o">=</span> <span class="n">_try_to_get_null_value_xarray</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">normalize_xarray_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xdata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>

    <span class="n">xmask</span> <span class="o">=</span> <span class="n">get_mask_from_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">nv</span><span class="p">)</span>
    <span class="n">orig_nv</span> <span class="o">=</span> <span class="n">nv</span>
    <span class="n">nv</span> <span class="o">=</span> <span class="n">reconcile_nullvalue_with_dtype</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">orig_nv</span><span class="p">)</span> <span class="ow">or</span> <span class="n">orig_nv</span> <span class="o">!=</span> <span class="n">nv</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr_where_with_meta</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataarray_to_xr_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="o">=</span><span class="n">xmask</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_dataset_to_raster_ds</span><span class="p">(</span><span class="n">ds_in</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">ds_in</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;raster&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">}</span>
        <span class="ow">and</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">raster</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">chunks</span> <span class="o">==</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">chunks</span>
        <span class="ow">and</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span> <span class="o">==</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">ds_in</span>

    <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nvars</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">nvars</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;raster&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Dataset input must have only &#39;raster&#39; and &#39;mask&#39; variables&quot;</span>
        <span class="p">)</span>

    <span class="n">xdata</span> <span class="o">=</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">raster</span>
    <span class="n">xmask</span> <span class="o">=</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">xmask</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;mask must have boolean dtype&quot;</span><span class="p">)</span>

    <span class="n">xdata</span> <span class="o">=</span> <span class="n">normalize_xarray_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="n">xmask</span> <span class="o">=</span> <span class="n">normalize_xarray_data</span><span class="p">(</span><span class="n">xmask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xmask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;raster and mask dimensions do not match&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dask</span><span class="o">.</span><span class="n">is_dask_collection</span><span class="p">(</span><span class="n">xmask</span><span class="p">):</span>
        <span class="n">xmask</span> <span class="o">=</span> <span class="n">xmask</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="n">to_chunk_dict</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>

    <span class="n">nv</span> <span class="o">=</span> <span class="n">_try_to_get_null_value_xarray</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">get_default_null_value</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">reconcile_nullvalue_with_dtype</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr_where_with_meta</span><span class="p">(</span><span class="n">xmask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="n">nv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataarray_to_xr_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xmask</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_xarray_input_to_raster_ds</span><span class="p">(</span><span class="n">xin</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_dataarray_input_to_raster_ds</span><span class="p">(</span><span class="n">xin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_dataset_to_raster_ds</span><span class="p">(</span><span class="n">xin</span><span class="p">)</span>


<div class="viewcode-block" id="get_raster_ds"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.get_raster_ds">[docs]</a><span class="k">def</span> <span class="nf">get_raster_ds</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
    <span class="c1"># Copy to take ownership</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">Raster</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">_xarray_input_to_raster_ds</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">_array_input_to_raster_ds</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span> <span class="ow">in</span> <span class="n">IO_UNDERSTOOD_TYPES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_batch_file</span><span class="p">(</span><span class="n">raster</span><span class="p">):</span>
            <span class="c1"># Import here to avoid circular import errors</span>
            <span class="kn">from</span> <span class="nn">raster_tools.batch</span> <span class="kn">import</span> <span class="n">parse_batch_script</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">parse_batch_script</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="o">.</span><span class="n">final_raster</span><span class="o">.</span><span class="n">_ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">open_raster_from_path_or_url</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dataarray_to_xr_raster_ds</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not resolve input to a raster: </span><span class="si">{</span><span class="n">raster</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<span class="n">RasterQuadrantsResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;RasterQuadrantsResult&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="Raster"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.html#raster_tools.raster.Raster">[docs]</a><span class="k">class</span> <span class="nc">Raster</span><span class="p">(</span><span class="n">_RasterBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstraction of georeferenced raster data with lazy function evaluation.</span>

<span class="sd">    Raster is a wrapper around xarray Datasets and DataArrays. It takes</span>
<span class="sd">    advantage of xarray&#39;s dask integration to allow lazy loading and</span>
<span class="sd">    evaluation. It allows a pipeline of operations on underlying raster</span>
<span class="sd">    sources to be built in a lazy fashion and then evaluated effiently.</span>
<span class="sd">    Most mathematical operations have been overloaded so operations such as</span>
<span class="sd">    ``z = x - y`` and ``r = x**2`` are possible.</span>

<span class="sd">    All operations on a Raster return a new Raster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raster : str, Raster, xarray.DataArray, xarray.Dataset, numpy.ndarray</span>
<span class="sd">        The raster source to use for this Raster. If `raster` is a string,</span>
<span class="sd">        it is treated like a path. If `raster` is a Raster, a copy is made</span>
<span class="sd">        and its raster source is used. If `raster` is an xarray DataArray,</span>
<span class="sd">        Dataset, or numpy array, it is used as the source. Dataset objects must</span>
<span class="sd">        contain &#39;raster&#39; and &#39;mask&#39; variables. The dimensions of these</span>
<span class="sd">        variables are assumed to be &quot;band&quot;, &quot;y&quot;, &quot;x&quot;, in that order. The &#39;mask&#39;</span>
<span class="sd">        variable must have boolean dtype.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_ds&quot;</span><span class="p">,)</span>

<div class="viewcode-block" id="Raster.__init__"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.html#raster_tools.raster.Raster.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_fast_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">raster</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">get_raster_ds</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: implement</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;raster_tools.Raster (crs=&#39;</span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">&#39;, masked=</span><span class="si">{</span><span class="n">masked</span><span class="si">}</span><span class="s2">)&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">null_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The raster&#39;s null value used to fill missing or invalid entries.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_masked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The underlying :class:`xarray.DataArray` (read only)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The underlying dask array of data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The raw internal raster as a numpy array.</span>

<span class="sd">        .. note::</span>
<span class="sd">           This triggers computation and loads the raster data into memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The null value mask as a dask array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xmask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The null value mask as an xarray DataArray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The band coordinate values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The x (horizontal) coordinate values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The y (vertical) coordinate values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dtype of the data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The shape of the underlying raster. Dim 0 is the band dimension.</span>

<span class="sd">        The shape will always be of the form ``(B, Y, X)`` where ``B`` is the</span>
<span class="sd">        band dimension, ``Y`` is the y dimension, and ``X`` is the x dimension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of grid cells across all bands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of bands.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The raster&#39;s CRS.</span>

<span class="sd">        This is a :obj:`rasterio.crs.CRS` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">affine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The affine transformation for the raster data.</span>

<span class="sd">        This is an :obj:`affine.Affine` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The x and y cell sizes as a tuple. Values are always positive.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bounds tuple (minx, miny, maxx, maxy)&quot;&quot;&quot;</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;ul&quot;</span><span class="p">)</span>
        <span class="n">maxx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geobox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;GeoBox object describing the raster&#39;s grid.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">odc</span><span class="o">.</span><span class="n">geobox</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bandwise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an adapter for band-wise operations on this raster</span>

<span class="sd">        The returned adapter allows lists/arrays of values to be mapped to the</span>
<span class="sd">        raster&#39;s bands for binary operations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BandwiseOperationAdapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_rs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster._rs&#39; is deprecated. It will soon be removed. Use xdata.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster._data&#39; is deprecated. It will soon be removed. Use data.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster._values&#39; is deprecated. It will soon be removed. Use &quot;</span>
            <span class="s2">&quot;values.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster._mask&#39; is deprecated. It will soon be removed. Use mask.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_null_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster._null_value&#39; is deprecated. It will soon be removed. Use &quot;</span>
            <span class="s2">&quot;null_value.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster.xrs&#39; is deprecated. It will soon be removed. Use xdata.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pxrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Raster.pxrs&#39; is deprecated. It will soon be removed.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">get_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">null_to_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geochunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce an array of GeoChunks that correspond to the underlying chunks</span>
<span class="sd">        in the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunks</span>
        <span class="n">chunks_shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">numblocks</span>
        <span class="n">geochunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">chunks_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">band_locations</span> <span class="o">=</span> <span class="n">chunks_to_array_locations</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_locations</span> <span class="o">=</span> <span class="n">chunks_to_array_locations</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_locations</span> <span class="o">=</span> <span class="n">chunks_to_array_locations</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">chunk_rasters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_chunk_rasters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">chunks_shape</span><span class="p">):</span>
            <span class="n">chunk_raster</span> <span class="o">=</span> <span class="n">chunk_rasters</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
            <span class="n">geochunks</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">=</span> <span class="n">GeoChunk</span><span class="p">(</span>
                <span class="n">chunk_raster</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">chunk_raster</span><span class="o">.</span><span class="n">geobox</span><span class="p">,</span>
                <span class="n">affine</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="n">band_locations</span><span class="p">[</span><span class="n">bi</span><span class="p">],</span>
                    <span class="n">y_locations</span><span class="p">[</span><span class="n">yi</span><span class="p">],</span>
                    <span class="n">x_locations</span><span class="p">[</span><span class="n">xi</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoChunkArray</span><span class="p">(</span><span class="n">geochunks</span><span class="p">)</span>

<div class="viewcode-block" id="Raster.chunk"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.chunk.html#raster_tools.raster.Raster.chunk">[docs]</a>    <span class="k">def</span> <span class="nf">chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rechunk the underlying raster</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunks : tuple of int</span>
<span class="sd">            The chunk sizes for each dimension (&quot;band&quot;, &quot;y&quot;, &quot;x&quot;, in that</span>
<span class="sd">            order). Must be a 3-tuple.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The rechunked raster</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">chunks</span><span class="p">))),</span>
            <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Raster.to_dataset"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.to_dataset.html#raster_tools.raster.Raster.to_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the underlying `xarray.Dataset`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span></div>

<div class="viewcode-block" id="Raster.to_numpy"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.to_numpy.html#raster_tools.raster.Raster.to_numpy">[docs]</a>    <span class="k">def</span> <span class="nf">to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the raw internal raster as a numpy array.</span>

<span class="sd">        .. note::</span>
<span class="sd">           This triggers computation and loads the raster data into memory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.plot"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.plot.html#raster_tools.raster.Raster.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the raster. Args and kwargs are passed to xarray&#39;s plot function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">null_to_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.explore"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.explore.html#raster_tools.raster.Raster.explore">[docs]</a>    <span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the raster band on an interactive :py:mod:`folium` map.</span>

<span class="sd">        This allows for rapid data exploration. Any extra arguments or keyword</span>
<span class="sd">        arguments are passed on to `odc-geo`&#39;s `explore` function.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This function is very experimental.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        band : int</span>
<span class="sd">            The band to plot. Bands use 1-based indexing so this value must be</span>
<span class="sd">            greater than 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : folium.folium.Map</span>
<span class="sd">            The resulting py:mod:`folium` map.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">band</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Band value must be an integer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specified band must be greater than 0&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span><span class="o">.</span><span class="n">odc</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.get_chunked_coords"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.get_chunked_coords.html#raster_tools.raster.Raster.get_chunked_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunked_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get lazy coordinate arrays, in x-y order, chunked to match data.&quot;&quot;&quot;</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span></div>

<div class="viewcode-block" id="Raster.close"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.close.html#raster_tools.raster.Raster.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the underlying source&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.save"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.save.html#raster_tools.raster.Raster.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">no_data_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">gdal_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the final raster and save it to the provided location.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The target location to save the raster to.</span>
<span class="sd">        no_data_value : scalar, optional</span>
<span class="sd">            A new null value to use when saving.</span>
<span class="sd">        **gdal_kwargs : kwargs, optional</span>
<span class="sd">            Additional keyword arguments to to pass to rasterio and GDAL when</span>
<span class="sd">            writing the raster data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            A raster pointing to the saved location.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: warn of overwrite</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">no_data_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_null_value</span><span class="p">(</span><span class="n">no_data_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">_masked</span> <span class="ow">and</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="c1"># Cast to uint and burn in mask</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_null_value</span><span class="p">(</span>
                <span class="n">get_default_null_value</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">xrs</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">xdata</span>
        <span class="n">write_raster</span><span class="p">(</span>
            <span class="n">xrs</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">null_value</span> <span class="k">if</span> <span class="n">no_data_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">no_data_value</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gdal_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.load"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.load.html#raster_tools.raster.Raster.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute delayed operations and load the result into memory.</span>

<span class="sd">        This computes all delayed operations built up so far and then stores</span>
<span class="sd">        the resulting raster in memory. This can have significant performance</span>
<span class="sd">        implications if the raster data being computed is large relative to the</span>
<span class="sd">        available computer memory. The original raster is unaltered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
        <span class="c1"># A new raster is returned to mirror the xarray and dask APIs</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.eval"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.eval.html#raster_tools.raster.Raster.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: A003</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute any applied operations and return the result as new Raster.</span>

<span class="sd">        Note that the unerlying sources will be loaded into memory for the</span>
<span class="sd">        computations and the result will be fixed in memory. The original</span>
<span class="sd">        Raster will be unaltered.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method has been replaced by :meth:`load` and will eventually</span>
<span class="sd">            be deprecated and then removed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: deprecate in favor of load</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.copy"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.copy.html#raster_tools.raster.Raster.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a copy of this Raster.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.astype"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.astype.html#raster_tools.raster.Raster.astype">[docs]</a>    <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">warn_about_null_change</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of the Raster cast to the specified type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype : str, type, numpy.dtype</span>
<span class="sd">            The new type to cast the raster to. The null value will also be</span>
<span class="sd">            cast to this type. If the null value cannot be safely cast to the</span>
<span class="sd">            new type, a default null value for the given `dtype` is used. This</span>
<span class="sd">            will produce a warning unless `warn_about_null_change` is set to</span>
<span class="sd">            ``False``.</span>
<span class="sd">        warn_about_null_change : bool, optional</span>
<span class="sd">            Can be used to silence warnings. The default is to always warn</span>
<span class="sd">            about null value changes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The new `dtype` raster.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DTYPE_INPUT_TO_DTYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type: &#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">DTYPE_INPUT_TO_DTYPE</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">xrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span>

        <span class="n">xrs</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="n">reconcile_nullvalue_with_dtype</span><span class="p">(</span>
                <span class="n">nv</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">warn_about_null_change</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">nv</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span><span class="p">:</span>
                <span class="n">xrs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">xrs</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xrs</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.get_bands"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.get_bands.html#raster_tools.raster.Raster.get_bands">[docs]</a>    <span class="k">def</span> <span class="nf">get_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the specified bands as a new Raster. Indexing starts at 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bands : int or sequence of ints</span>
<span class="sd">            The band or bands to be retrieved. A single band Raster is returned</span>
<span class="sd">            if `bands` is an int and a multiband Raster is returned if it is a</span>
<span class="sd">            sequence. The band numbers may be out of order and contain repeated</span>
<span class="sd">            elements. if `bands` is a sequence, the multiband raster&#39;s bands</span>
<span class="sd">            will be in the order provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting raster composed of the specified bands in the order</span>
<span class="sd">            given.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All band numbers must be integers&quot;</span><span class="p">)</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No bands provided&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;One or more band numbers were out of bounds: </span><span class="si">{</span><span class="n">bands</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># We have to do sel() followed by concat() in order to get size 1</span>
        <span class="c1"># chunking along the band dim</span>
        <span class="n">dss</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dss</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
        <span class="c1"># Reset band numbering</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.set_crs"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.set_crs.html#raster_tools.raster.Raster.set_crs">[docs]</a>    <span class="k">def</span> <span class="nf">set_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the CRS for the underlying data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        crs : object</span>
<span class="sd">            The desired CRS. This can be anything accepted by</span>
<span class="sd">            :obj:`rasterio.crs.CRS.from_user_input` (i.e. `4326`,</span>
<span class="sd">            `&quot;epsg:4326&quot;`, etc).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            A new raster with the specified CRS.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">),</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.set_null_value"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.set_null_value.html#raster_tools.raster.Raster.set_null_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_null_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets or replaces the null value for the raster.</span>

<span class="sd">        If there was previously no null value for the raster, one is set. If</span>
<span class="sd">        there was already a null value, then it is replaced. If the raster has</span>
<span class="sd">        an integer dtype and `value` is a float, the dtype will be promoted to</span>
<span class="sd">        a float dtype. If `value` is None, the null value is cleared. The</span>
<span class="sd">        raster data is not changed in this case.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : scalar or None</span>
<span class="sd">            The new null value for the raster. If None, the resulting raster</span>
<span class="sd">            will have no null value, i.e. the null value is cleared.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The new resulting Raster.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_scalar</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value must be a scalar or None: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">xrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Cast up to float if needed</span>
        <span class="k">if</span> <span class="n">should_promote_to_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">xrs</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">promote_dtype_to_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Burn in current mask values and then clear null value</span>
            <span class="c1"># TODO: burning should not be needed as the values should already</span>
            <span class="c1"># be set</span>
            <span class="n">xrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn_mask</span><span class="p">()</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xrs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xrs</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Update mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">get_mask_from_data</span><span class="p">(</span><span class="n">xrs</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">temp_mask</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span> <span class="k">else</span> <span class="n">temp_mask</span>
        <span class="n">xrs</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xrs</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">burn_mask</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.set_null"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.set_null.html#raster_tools.raster.Raster.set_null">[docs]</a>    <span class="k">def</span> <span class="nf">set_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_raster</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the raster&#39;s null pixels using the provided mask</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask_raster : str, Raster</span>
<span class="sd">            Raster or path to a raster that is used to update the masked out</span>
<span class="sd">            pixels. This raster updates the mask. It does not replace the mask.</span>
<span class="sd">            Pixels that were already marked as null stay null and pixels that</span>
<span class="sd">            are marked as null in `mask_raster` become marked as null in the</span>
<span class="sd">            resulting raster. This is a logical &quot;OR&quot; operation. `mask_raster`</span>
<span class="sd">            must have data type of boolean, int8, or uint8. `mask_raster` must</span>
<span class="sd">            have either 1 band or the same number of bands as the raster it is</span>
<span class="sd">            being applied to. A single band `mask_raster` is broadcast across</span>
<span class="sd">            all bands of the raster being modified.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting raster with updated mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask_raster</span> <span class="o">=</span> <span class="n">get_raster</span><span class="p">(</span><span class="n">mask_raster</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">nbands</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">nbands</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The number of bands in mask_raster must be 1 or match&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; this raster. Got </span><span class="si">{</span><span class="n">mask_raster</span><span class="o">.</span><span class="n">nbands</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;x and y dims for mask_raster do not match this raster.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">mask_raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">BOOL</span><span class="p">,</span> <span class="n">I8</span><span class="p">,</span> <span class="n">U8</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;mask_raster must be boolean, int8, or uint8&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
            <span class="n">mask_raster</span> <span class="o">=</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">out_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_mask_data</span> <span class="o">=</span> <span class="n">out_raster</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># Rely on numpy broadcasting when applying the new mask data</span>
        <span class="k">if</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
            <span class="n">new_mask_data</span> <span class="o">|=</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_raster</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_mask_data</span> <span class="o">|=</span> <span class="n">mask_raster</span><span class="o">.</span><span class="n">data</span>
        <span class="n">out_raster</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_mask_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
            <span class="n">out_raster</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s2">&quot;raster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_raster</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span>
                <span class="n">get_default_null_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Burn mask to set null values in newly masked regions</span>
        <span class="k">return</span> <span class="n">out_raster</span><span class="o">.</span><span class="n">burn_mask</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.burn_mask"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.burn_mask.html#raster_tools.raster.Raster.burn_mask">[docs]</a>    <span class="k">def</span> <span class="nf">burn_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill null-masked cells with null value.</span>

<span class="sd">        Use this as a way to return the underlying data to a known state. If</span>
<span class="sd">        dtype is boolean, the null cells are set to ``True`` instead of</span>
<span class="sd">        promoting to fit the null value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span>
        <span class="k">if</span> <span class="n">is_bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="c1"># Sanity check to make sure that boolean rasters get a boolean null</span>
            <span class="c1"># value</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="n">get_default_null_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">out_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Work with .data to avoid dropping attributes caused by using xarray</span>
        <span class="c1"># and rioxarrays&#39; APIs</span>
        <span class="n">out_raster</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_raster</span></div>

<div class="viewcode-block" id="Raster.to_null_mask"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.to_null_mask.html#raster_tools.raster.Raster.to_null_mask">[docs]</a>    <span class="k">def</span> <span class="nf">to_null_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a boolean Raster with True at null values and False otherwise.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting mask Raster. It is True where this raster contains</span>
<span class="sd">            null values and False everywhere else.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span>
            <span class="n">make_raster_ds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Raster.replace_null"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.replace_null.html#raster_tools.raster.Raster.replace_null">[docs]</a>    <span class="k">def</span> <span class="nf">replace_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replaces null values with `value`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : scalar</span>
<span class="sd">            The new value to replace null values with.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The new resulting Raster. If `value` is a float and the raster</span>
<span class="sd">            dtype is int, the raster type will be promoted to float.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_scalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;value must be a scalar&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_null_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.where"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.where.html#raster_tools.raster.Raster.where">[docs]</a>    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter elements from this raster according to `condition`.</span>

<span class="sd">        The mask for the result is a combination of all three rasters. Any</span>
<span class="sd">        cells that are masked in the condition raster will be masked in the</span>
<span class="sd">        output. The rest of the cells are masked based on which raster they</span>
<span class="sd">        were taken from, as determined by the condition raster, and if the cell</span>
<span class="sd">        in that raster was null. Effectively, the resulting mask is determined</span>
<span class="sd">        as follows: `where(condition.mask, True, where(condition,</span>
<span class="sd">        true_rast.mask, false_rast.mask)`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        condition : str or Raster</span>
<span class="sd">            A boolean or int raster that indicates where elements in this</span>
<span class="sd">            raster should be preserved and where `other` should be used. If</span>
<span class="sd">            the condition is an int raster, it is coerced to bool using</span>
<span class="sd">            `condition &gt; 0`.  ``True`` cells pull values from this raster and</span>
<span class="sd">            ``False`` cells pull from `other`. *str* is treated as a path to a</span>
<span class="sd">            raster.</span>
<span class="sd">        other : scalar, str or Raster, None</span>
<span class="sd">            A raster or value to use in locations where `condition` is</span>
<span class="sd">            ``False``. *str* is treated as a path to a raster. If None, this is</span>
<span class="sd">            treated as a null value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting filtered Raster.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">raster_tools.general</span> <span class="kn">import</span> <span class="n">where</span>

        <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.remap_range"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.remap_range.html#raster_tools.raster.Raster.remap_range">[docs]</a>    <span class="k">def</span> <span class="nf">remap_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">inclusivity</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remaps values based on a mapping or list of mappings.</span>

<span class="sd">        Mappings are applied all at once with earlier mappings taking</span>
<span class="sd">        precedence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mapping : 3-tuple of scalars or list of 3-tuples of scalars</span>
<span class="sd">            A tuple or list of tuples containing ``(min, max, new_value)``</span>
<span class="sd">            scalars. The mappiing(s) map values between the min and max to the</span>
<span class="sd">            ``new_value``. If ``new_value`` is ``None``, the matching pixels</span>
<span class="sd">            will be marked as null. If `mapping` is a list and there are</span>
<span class="sd">            mappings that conflict or overlap, earlier mappings take</span>
<span class="sd">            precedence. `inclusivity` determines which sides of the range are</span>
<span class="sd">            inclusive and exclusive.</span>
<span class="sd">        inclusivity : str, optional</span>
<span class="sd">            Determines whether to be inclusive or exclusive on either end of</span>
<span class="sd">            the range. Default is `&#39;left&#39;`.</span>

<span class="sd">            &#39;left&#39; [min, max)</span>
<span class="sd">                Left (min) side is inclusive and right (max) side is exclusive.</span>
<span class="sd">            &#39;right&#39; (min, max]</span>
<span class="sd">                Left (min) side is exclusive and right (max) side is inclusive.</span>
<span class="sd">            &#39;both&#39; [min, max]</span>
<span class="sd">                Both sides are inclusive.</span>
<span class="sd">            &#39;none&#39; (min, max)</span>
<span class="sd">                Both sides are exclusive.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting Raster.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        raster_tools.general.remap_range</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># local import to avoid circular import</span>
        <span class="kn">from</span> <span class="nn">raster_tools.general</span> <span class="kn">import</span> <span class="n">remap_range</span>

        <span class="k">return</span> <span class="n">remap_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">inclusivity</span><span class="o">=</span><span class="n">inclusivity</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.model_predict"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.model_predict.html#raster_tools.raster.Raster.model_predict">[docs]</a>    <span class="k">def</span> <span class="nf">model_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a new raster using the provided model to predict new values.</span>

<span class="sd">        The raster&#39;s values are used as the predictor inputs for `model`.</span>
<span class="sd">        Each band in the input raster is used as a separate input variable.</span>
<span class="sd">        Outputs are raster surfaces where each band corresponds to a variable</span>
<span class="sd">        output by `model`.</span>

<span class="sd">        The `model` argument must provide a `predict` method. If the desired</span>
<span class="sd">        model does not provide a `predict` function,</span>
<span class="sd">        :class:`ModelPredictAdaptor` can be used to wrap it and make it</span>
<span class="sd">        compatible with this function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : object</span>
<span class="sd">            The model used to estimate new values. It must have a `predict`</span>
<span class="sd">            method that takes an array-like object of shape `(N, M)`, where `N`</span>
<span class="sd">            is the number of samples and `M` is the number of</span>
<span class="sd">            features/predictor variables. The `predict` method should return an</span>
<span class="sd">            `(N, [n_outputs])` shape result. If only one variable is resurned,</span>
<span class="sd">            then the `n_outputs` dimension is optional.</span>
<span class="sd">        n_outputs : int, optional</span>
<span class="sd">            The number of output variables from the model. Each output variable</span>
<span class="sd">            produced by the model is converted to a band in output raster. The</span>
<span class="sd">            default is ``1``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The resulting raster of estimated values. Each band corresponds to</span>
<span class="sd">            an output variable produced by the `model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">raster_tools.general</span> <span class="kn">import</span> <span class="n">model_predict_raster</span>

        <span class="k">return</span> <span class="n">model_predict_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.reclassify"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.reclassify.html#raster_tools.raster.Raster.reclassify">[docs]</a>    <span class="k">def</span> <span class="nf">reclassify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remapping</span><span class="p">,</span> <span class="n">unmapped_to_null</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reclassify raster values based on a mapping.</span>

<span class="sd">        The raster must have an integer type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remapping : str, dict</span>
<span class="sd">            Can be either a ``dict`` or a path string. If a ``dict`` is</span>
<span class="sd">            provided, the keys will be reclassified to the corresponding</span>
<span class="sd">            values. It is possible to map values to the null value by providing</span>
<span class="sd">            ``None`` in the mapping. If a path string, it is treated as an</span>
<span class="sd">            ASCII remap file where each line looks like ``a:b`` and ``a`` and</span>
<span class="sd">            ``b`` are scalars. ``b`` can also be &quot;NoData&quot;. This indicates that</span>
<span class="sd">            ``a`` will be mapped to the null value. The output values of the</span>
<span class="sd">            mapping can cause type promotion. If the input raster has integer</span>
<span class="sd">            data and one of the outputs in the mapping is a float, the result</span>
<span class="sd">            will be a float raster.</span>
<span class="sd">        unmapped_to_null : bool, optional</span>
<span class="sd">            If ``True``, values not included in the mapping are instead mapped</span>
<span class="sd">            to the null value. Default is ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The remapped raster.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">raster_tools.general</span> <span class="kn">import</span> <span class="n">reclassify</span>

        <span class="k">return</span> <span class="n">reclassify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remapping</span><span class="p">,</span> <span class="n">unmapped_to_null</span><span class="o">=</span><span class="n">unmapped_to_null</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.round"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.round.html#raster_tools.raster.Raster.round">[docs]</a>    <span class="k">def</span> <span class="nf">round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># noqa: A003</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evenly round to the given number of decimals</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        decimals : int, optional</span>
<span class="sd">            The number of decimal places to round to. If negative, value</span>
<span class="sd">            specifies the number of positions to the left of the decimal point.</span>
<span class="sd">            Default is 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            Rounded raster.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
            <span class="n">rast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_value</span><span class="p">,</span> <span class="n">rast</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">null_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rast</span> <span class="o">=</span> <span class="n">rast</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.reproject"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.reproject.html#raster_tools.raster.Raster.reproject">[docs]</a>    <span class="k">def</span> <span class="nf">reproject</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">crs_or_geobox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resample_method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reproject to a new projection or resolution.</span>

<span class="sd">        This is a lazy operation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        crs_or_geobox : int, str, CRS, GeoBox, optional</span>
<span class="sd">            The target grid to reproject the raster to. This can be a</span>
<span class="sd">            projection string, EPSG code string or integer, a CRS object, or a</span>
<span class="sd">            GeoBox object. `resolution` can also be specified to change the</span>
<span class="sd">            output raster&#39;s resolution in the new CRS. If `crs_or_geobox` is</span>
<span class="sd">            not provided, `resolution` must be specified.</span>
<span class="sd">        resample_method : str, optional</span>
<span class="sd">            The data resampling method to use. Null pixels are ignored for all</span>
<span class="sd">            methods. Some methods require specific versions of GDAL. These are</span>
<span class="sd">            noted below. Valid methods are:</span>

<span class="sd">            &#39;nearest&#39;</span>
<span class="sd">                Nearest neighbor resampling. This is the default.</span>
<span class="sd">            &#39;bilinear&#39;</span>
<span class="sd">                Bilinear resmapling.</span>
<span class="sd">            &#39;cubic&#39;</span>
<span class="sd">                Cubic resmapling.</span>
<span class="sd">            &#39;cubic_spline&#39;</span>
<span class="sd">                Cubic spline resmapling.</span>
<span class="sd">            &#39;lanczos&#39;</span>
<span class="sd">                Lanczos windowed sinc resmapling.</span>
<span class="sd">            &#39;average&#39;</span>
<span class="sd">                Average resampling, computes the weighted average of all</span>
<span class="sd">                contributing pixels.</span>
<span class="sd">            &#39;mode&#39;</span>
<span class="sd">                Mode resampling, selects the value which appears most often.</span>
<span class="sd">            &#39;max&#39;</span>
<span class="sd">                Maximum resampling. (GDAL 2.0+)</span>
<span class="sd">            &#39;min&#39;</span>
<span class="sd">                Minimum resampling. (GDAL 2.0+)</span>
<span class="sd">            &#39;med&#39;</span>
<span class="sd">                Median resampling. (GDAL 2.0+)</span>
<span class="sd">            &#39;q1&#39;</span>
<span class="sd">                Q1, first quartile resampling. (GDAL 2.0+)</span>
<span class="sd">            &#39;q3&#39;</span>
<span class="sd">                Q3, third quartile resampling. (GDAL 2.0+)</span>
<span class="sd">            &#39;sum&#39;</span>
<span class="sd">                Sum, compute the weighted sum. (GDAL 3.1+)</span>
<span class="sd">            &#39;rms&#39;</span>
<span class="sd">                RMS, root mean square/quadratic mean. (GDAL 3.3+)</span>
<span class="sd">        resolution : int, float, tuple of int or float, optional</span>
<span class="sd">            The desired resolution of the reprojected raster. If</span>
<span class="sd">            `crs_or_geobox` is unspecified, this is used to reproject to the</span>
<span class="sd">            new resolution while maintaining the same CRS. One of</span>
<span class="sd">            `crs_or_geobox` or `resolution` must be provided. Both can also be</span>
<span class="sd">            provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Raster</span>
<span class="sd">            The reprojected raster on the new grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">raster_tools.warp</span> <span class="kn">import</span> <span class="n">reproject</span>

        <span class="k">return</span> <span class="n">reproject</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">crs_or_geobox</span><span class="o">=</span><span class="n">crs_or_geobox</span><span class="p">,</span>
            <span class="n">resample_method</span><span class="o">=</span><span class="n">resample_method</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Raster.xy"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.xy.html#raster_tools.raster.Raster.xy">[docs]</a>    <span class="k">def</span> <span class="nf">xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the `(x, y)` coordinates of the pixel at `(row, col)`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        row : int, float, array-like</span>
<span class="sd">            row value(s) in the raster&#39;s CRS</span>
<span class="sd">        col : int, float, array-like</span>
<span class="sd">            row value(s) in the raster&#39;s CRS</span>
<span class="sd">        offset : str, optional</span>
<span class="sd">            Determines if the returned coordinates are for the center or a</span>
<span class="sd">            corner. Default is `&#39;center&#39;`</span>

<span class="sd">            &#39;center&#39;</span>
<span class="sd">                The pixel center.</span>
<span class="sd">            &#39;ul&#39;</span>
<span class="sd">                The upper left corner.</span>
<span class="sd">            &#39;ur&#39;</span>
<span class="sd">                The upper right corner.</span>
<span class="sd">            &#39;ll&#39;</span>
<span class="sd">                The lower left corner.</span>
<span class="sd">            &#39;lr&#39;</span>
<span class="sd">                The lower right corner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (x value(s), y value(s)). If the inputs where array-like, the</span>
<span class="sd">            output values will be arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rowcol_to_xy</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.index"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.index.html#raster_tools.raster.Raster.index">[docs]</a>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the `(row, col)` index of the pixel at `(x, y)`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float, array-like</span>
<span class="sd">            x value(s) in the raster&#39;s CRS</span>
<span class="sd">        y : float, array-like</span>
<span class="sd">            y value(s) in the raster&#39;s CRS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (row value(s), col value(s)). If the inputs where array-like, the</span>
<span class="sd">            output values will be arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xy_to_rowcol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.to_polygons"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.Raster.to_polygons">[docs]</a>    <span class="k">def</span> <span class="nf">to_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the raster to a vector of polygons.</span>

<span class="sd">        Null cells are ignored. The resulting vector is randomly ordered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        neighbors : {4, 8} int, optional</span>
<span class="sd">            This determines how many neighboring cells to consider when joining</span>
<span class="sd">            cells together to form polygons. Valid values are ``4`` and ``8``.</span>
<span class="sd">            ``8`` causes diagonal neighbors to be used. Default is ``4``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dask_geopandas.GeoDataFrame</span>
<span class="sd">            A `GeoDataFrame` with columns: value, band, geometry. The geometry</span>
<span class="sd">            column contains polygons/multi-polygons.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The algorithm used by this method is best used with simple thematic</span>
<span class="sd">        data. This is because the algorithm consumes memory proportional to the</span>
<span class="sd">        number and complexity of the produced polygons. Data that produces a</span>
<span class="sd">        large number of polygons, i.e. data with high pixel-to-pixel</span>
<span class="sd">        variability, will cause a large amount of memory to be consumed.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Raster.to_vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">neighbors</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;neighbors can only be 4 or 8&quot;</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">I64</span><span class="p">),</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(()),</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Iterate over bands because dissolve will join polygons from different</span>
        <span class="c1"># bands, otherwise.</span>
        <span class="n">band_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbands</span><span class="p">):</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">mask_chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span><span class="o">.</span><span class="n">affine</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bands</span><span class="p">(</span><span class="n">iband</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get_chunk_rasters</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="n">partitions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chnk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">transform</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">mask_chunks</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span>
                    <span class="n">_shapes_delayed</span><span class="p">(</span>
                        <span class="n">chnk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">iband</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
                    <span class="p">),</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">partitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="c1"># Dissolve uses the &#39;by&#39; column to create the new index. Reset the</span>
            <span class="c1"># index to turn it back into a regular column.</span>
            <span class="n">band_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">dd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">band_results</span><span class="p">)</span>
            <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">npartitions</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Raster.to_vector"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.to_vector.html#raster_tools.raster.Raster.to_vector">[docs]</a>    <span class="k">def</span> <span class="nf">to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the raster to a vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        as_polygons : bool, optional</span>
<span class="sd">            If ``True``, the raster is converted to polygons/multi-polygon,</span>
<span class="sd">            each polyon/mult-polygon is made up of like-valued cells. Null</span>
<span class="sd">            cells are ignored. :meth:`to_polygons` for more information. If</span>
<span class="sd">            ``False``, the raster is converted to points. Each non-null cell is</span>
<span class="sd">            a point in the output. See :meth:`to_points` for more information.</span>
<span class="sd">            Default is ``False``.</span>
<span class="sd">        neighbors : {4, 8} int, optional</span>
<span class="sd">            Used when `as_polygons` is ``True``. This determines how many</span>
<span class="sd">            neighboring cells to consider when joining cells together to form</span>
<span class="sd">            polygons. Valid values are ``4`` and ``8``. ``8`` causes diagonal</span>
<span class="sd">            neighbors to be used. Default is ``4``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dask_geopandas.GeoDataFrame</span>
<span class="sd">            A `GeoDataFrame`. If `as_polygons` is ``True``, the result is a</span>
<span class="sd">            dataframe with columns: value, band, geometry. The geometry column</span>
<span class="sd">            will contain polygons. If ``False``, the result has columns: value,</span>
<span class="sd">            band, row, col, geometry. The geometry column will contain points.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Raster.to_points, Raster.to_polygons</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_polygons</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_polygons</span><span class="p">(</span><span class="n">neighbors</span><span class="o">=</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_points</span><span class="p">()</span></div>

<div class="viewcode-block" id="Raster.to_points"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.Raster.to_points">[docs]</a>    <span class="k">def</span> <span class="nf">to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the raster into a vector where each non-null cell is a point.</span>

<span class="sd">        The resulting points are located at the center of each grid cell.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dask_geopandas.GeoDataFrame</span>
<span class="sd">            The result is a dask_geopandas GeoDataFrame with the following</span>
<span class="sd">            columns: value, band, row, col, geometry. The value is the cell</span>
<span class="sd">            value at the row and column in the raster. Each row has a unique</span>
<span class="sd">            integer in the index. This is true across data frame partitions.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Raster.to_vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">raster</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data_delayed</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span>
        <span class="n">data_delayed</span> <span class="o">=</span> <span class="n">data_delayed</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">mask_delayed</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">geochunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geochunks</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># See issue for inspiration: https://github.com/dask/dask/issues/7589</span>
        <span class="c1"># Group chunk data with corresponding coordinate data</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_delayed</span><span class="p">,</span> <span class="n">mask_delayed</span><span class="p">,</span> <span class="n">geochunks</span><span class="p">))</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="s2">&quot;col&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">_vectorize</span><span class="p">(</span><span class="o">*</span><span class="n">chunk</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">dd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.to_quadrants"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.to_quadrants.html#raster_tools.raster.Raster.to_quadrants">[docs]</a>    <span class="k">def</span> <span class="nf">to_quadrants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the raster into quadrants</span>

<span class="sd">        This returns the quadrants of the raster in the order northwest,</span>
<span class="sd">        northeast, southwest, southeast.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : RasterQuadrantsResult</span>
<span class="sd">            The returned result is a `namedtuple` with attributes: `nw`, `ne`,</span>
<span class="sd">            `sw`, and `se`. Unpacking or indexing the object provides the</span>
<span class="sd">            quadrants in the stated order.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">slice_nw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">slice_ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
        <span class="n">slice_sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">slice_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:,</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">slice_nw</span><span class="p">,</span> <span class="n">slice_ne</span><span class="p">,</span> <span class="n">slice_sw</span><span class="p">,</span> <span class="n">slice_se</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">data_quad</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">mask_quad</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">x_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">y_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">xdata_quad</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">data_quad</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="n">y_quad</span><span class="p">,</span> <span class="n">x_quad</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">null_value</span><span class="p">)</span>
            <span class="n">xmask_quad</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">mask_quad</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="n">y_quad</span><span class="p">,</span> <span class="n">x_quad</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">make_raster_ds</span><span class="p">(</span><span class="n">xdata_quad</span><span class="p">,</span> <span class="n">xmask_quad</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">RasterQuadrantsResult</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.get_chunk_bounding_boxes"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.get_chunk_bounding_boxes.html#raster_tools.raster.Raster.get_chunk_bounding_boxes">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunk_bounding_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_band</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return GeoDataFrame with the chunk bounding boxes.</span>

<span class="sd">        This method generates a GeoDataFrame of bounding boxes for the</span>
<span class="sd">        underlying data chunks. By default it does this for a single band since</span>
<span class="sd">        the bounding boxes are the same across bands. The result also contains</span>
<span class="sd">        columns for the chunk position in the data.</span>

<span class="sd">        By default, the result has two position columns: `&#39;chunk_row&#39;` and</span>
<span class="sd">        `&#39;chunk_col&#39;`. Setting `include_band` adds `&#39;chunk_band&#39;`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_band : bool, optional</span>
<span class="sd">            Duplicates the result across bands and adds a third position column</span>
<span class="sd">            named `&#39;chunk_band&#39;`. Default is ``False``.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; dem = Raster(&quot;data/dem.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt; dem.get_chunk_bounding_boxes()</span>
<span class="sd">            chunk_row  chunk_col                                           geometry</span>
<span class="sd">        0           0          0  POLYGON ((-32863.383 53183.938, -32863.383 681...</span>
<span class="sd">        1           0          1  POLYGON ((-17863.383 53183.938, -17863.383 681...</span>
<span class="sd">        2           0          2  POLYGON ((-2863.383 53183.938, -2863.383 68183...</span>
<span class="sd">        3           0          3  POLYGON ((12136.617 53183.938, 12136.617 68183...</span>
<span class="sd">        4           0          4  POLYGON ((27136.617 53183.938, 27136.617 68183...</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; dem.get_chunk_bounding_boxes(True)</span>
<span class="sd">            chunk_band  chunk_row  chunk_col                                           geometry</span>
<span class="sd">        0            0          0          0  POLYGON ((-32863.383 53183.938, -32863.383 681...</span>
<span class="sd">        1            0          0          1  POLYGON ((-17863.383 53183.938, -17863.383 681...</span>
<span class="sd">        2            0          0          2  POLYGON ((-2863.383 53183.938, -2863.383 68183...</span>
<span class="sd">        3            0          0          3  POLYGON ((12136.617 53183.938, 12136.617 68183...</span>
<span class="sd">        4            0          0          4  POLYGON ((27136.617 53183.938, 27136.617 68183...</span>
<span class="sd">        ...</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ychunks</span><span class="p">,</span> <span class="n">xchunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chunk_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">yc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ychunks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">xc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xchunks</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">yc</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">xc</span><span class="p">]</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="n">xc</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">da</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">yc</span><span class="p">,</span> <span class="n">xc</span><span class="p">)),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
                <span class="n">chunk_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">))</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">yc</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_band</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;chunk_row&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">,</span>
                <span class="s2">&quot;chunk_col&quot;</span><span class="p">:</span> <span class="n">cols</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">chunk_boxes</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks_per_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbands</span><span class="p">):</span>
                <span class="n">bands</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">chunks_per_band</span>
            <span class="n">rows</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
            <span class="n">cols</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
            <span class="n">chunk_boxes</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;chunk_band&quot;</span><span class="p">:</span> <span class="n">bands</span><span class="p">,</span>
                <span class="s2">&quot;chunk_row&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">,</span>
                <span class="s2">&quot;chunk_col&quot;</span><span class="p">:</span> <span class="n">cols</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">chunk_boxes</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Raster.get_chunk_rasters"><a class="viewcode-back" href="../../reference/generated/raster_tools.Raster.get_chunk_rasters.html#raster_tools.raster.Raster.get_chunk_rasters">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunk_rasters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the underlying data chunks as an array of Rasters.</span>

<span class="sd">        This returns a 3D array where each element corresponds to a chunk of</span>
<span class="sd">        data. Each element is a Raster wrapping the corresponding chunk. The</span>
<span class="sd">        dimensions of the array are (n-bands, y-chunks, x-chunks). For</span>
<span class="sd">        example, if a Raster has 2 bands, 3 chunks in the y direction, and 4</span>
<span class="sd">        chunks in the x direction, this method would produce an array of</span>
<span class="sd">        Rasters with shape ``(2, 3, 4)``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            The 3D numpy array of chunk Rasters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bchunks</span><span class="p">,</span> <span class="n">ychunks</span><span class="p">,</span> <span class="n">xchunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numblocks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band</span><span class="p">,</span> <span class="n">bc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bchunks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">yc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ychunks</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">xc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xchunks</span><span class="p">):</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span>
                            <span class="n">band</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">bc</span><span class="p">),</span>
                            <span class="n">y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yc</span><span class="p">),</span>
                            <span class="n">x</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xc</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="n">rs</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_fast_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="n">xc</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="n">yc</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">b</span> <span class="o">+=</span> <span class="n">bc</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">out</span></div></div>


<span class="n">_offset_name_to_rc_offset</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="s2">&quot;ul&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;ur&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;ll&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>


<div class="viewcode-block" id="rowcol_to_xy"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.rowcol_to_xy">[docs]</a><span class="k">def</span> <span class="nf">rowcol_to_xy</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert (row, col) index values to (x, y) coords using the transformation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">roffset</span><span class="p">,</span> <span class="n">coffset</span> <span class="o">=</span> <span class="n">_offset_name_to_rc_offset</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">coffset</span><span class="p">,</span> <span class="n">roffset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">affine</span> <span class="o">*</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span></div>


<div class="viewcode-block" id="xy_to_rowcol"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.xy_to_rowcol">[docs]</a><span class="k">def</span> <span class="nf">xy_to_rowcol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">affine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert (x, y) coords to (row, col) index values using the transformation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">affine</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_extract_points</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">xc</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">yc</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">rx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ry</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">yc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_extract_values</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inv_affine</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="c1"># x, y, 1 for each column</span>
    <span class="n">xy1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">values</span><span class="p">,</span>
            <span class="n">bands</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">bands</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">xy1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">xy1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Use the inverse affine matrix to generate column and row values</span>
    <span class="n">cr1</span> <span class="o">=</span> <span class="n">inv_affine</span> <span class="o">@</span> <span class="n">xy1</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">values</span><span class="p">,</span>
        <span class="n">bands</span><span class="p">,</span>
        <span class="c1"># rows</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cr1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
        <span class="c1"># cols</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cr1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
        <span class="c1"># x</span>
        <span class="n">xy1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="c1"># y</span>
        <span class="n">xy1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>


<span class="nd">@dask</span><span class="o">.</span><span class="n">delayed</span>
<span class="k">def</span> <span class="nf">_vectorize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">geochunk</span><span class="p">):</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">_extract</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">geochunk</span><span class="o">.</span><span class="n">band</span><span class="p">,</span>
        <span class="n">geochunk</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">geochunk</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="c1"># Inverse affine transform matrix</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="o">~</span><span class="n">geochunk</span><span class="o">.</span><span class="n">parent_affine</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Use the index of each point in the flattened parent array as the pandas</span>
    <span class="c1"># index.</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">bands</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">geochunk</span><span class="o">.</span><span class="n">parent_shape</span><span class="p">)</span>
    <span class="n">bands</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">geochunk</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">,</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">bands</span><span class="p">,</span>
            <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">,</span>
            <span class="s2">&quot;col&quot;</span><span class="p">:</span> <span class="n">cols</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">geochunk</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">vec</span>


<span class="k">def</span> <span class="nf">_get_rio_shapes_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">I16</span><span class="p">,</span> <span class="n">I32</span><span class="p">,</span> <span class="n">U8</span><span class="p">,</span> <span class="n">U16</span><span class="p">,</span> <span class="n">F32</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dtype</span>

    <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="k">if</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">U8</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">I8</span><span class="p">:</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">I16</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">I64</span><span class="p">,</span> <span class="n">U32</span><span class="p">,</span> <span class="n">U64</span><span class="p">):</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">I32</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">F16</span><span class="p">,</span> <span class="n">F64</span><span class="p">):</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">F32</span>
    <span class="k">return</span> <span class="n">new_dtype</span>


<span class="nd">@dask</span><span class="o">.</span><span class="n">delayed</span>
<span class="k">def</span> <span class="nf">_shapes_delayed</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">crs</span><span class="p">):</span>
    <span class="c1"># Rasterio&#39;s shapes function only supports a small set of dtypes. This may</span>
    <span class="c1"># cause the dtype to be downcast.</span>
    <span class="c1"># ref: rasterio._features._shapes</span>
    <span class="n">orig_dtype</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">working_dtype</span> <span class="o">=</span> <span class="n">_get_rio_shapes_dtype</span><span class="p">(</span><span class="n">orig_dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">working_dtype</span> <span class="o">!=</span> <span class="n">orig_dtype</span><span class="p">:</span>
        <span class="c1"># Replace null values with a value that will work for all dtypes. Null</span>
        <span class="c1"># values are the most likely to produce warnings when down casting. The</span>
        <span class="c1"># null cells will be ignored in rio.features.shapes so the value</span>
        <span class="c1"># does not matter for computation.</span>
        <span class="n">chunk</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">working_dtype</span><span class="p">)</span>

    <span class="c1"># Invert because rasterio&#39;s shapes func uses False for masked cells.</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">geojson</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span>
        <span class="n">chunk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">transform</span>
    <span class="p">):</span>
        <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">geojson</span><span class="p">))</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Cast back to the original dtype, if needed</span>
    <span class="k">if</span> <span class="n">working_dtype</span> <span class="o">!=</span> <span class="n">orig_dtype</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">,</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">shapes</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_build_x_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">shape_3d</span><span class="p">):</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">shape_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Cell size for x dim</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">a</span>
    <span class="n">tmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmatrix</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nx</span><span class="p">)]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xc</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># Copy to trim off excess base array</span>
    <span class="k">return</span> <span class="n">xc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_build_y_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">shape_3d</span><span class="p">):</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">shape_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Cell size for y dim (should be &lt; 0)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">e</span>
    <span class="n">tmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmatrix</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ny</span><span class="p">)]))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yc</span> <span class="o">+=</span> <span class="n">e</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># Copy to trim off excess base array</span>
    <span class="k">return</span> <span class="n">yc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_build_coords</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_build_x_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span> <span class="n">_build_y_coord</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>


<div class="viewcode-block" id="GeoChunk"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk">[docs]</a><span class="k">class</span> <span class="nc">GeoChunk</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Object representing a geo-located chunk.</span>

<span class="sd">    A GeoChunk contains information needed to geo-locate a chunk and locate it</span>
<span class="sd">    within the parent array. It also has helper methods for manipulating that</span>
<span class="sd">    information. It is meant to be used to provide information to raster</span>
<span class="sd">    functions inside dask map operations.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">,</span>
        <span class="n">geobox</span><span class="p">,</span>
        <span class="n">parent_affine</span><span class="p">,</span>
        <span class="n">parent_shape</span><span class="p">,</span>
        <span class="n">array_location</span><span class="p">,</span>
        <span class="n">chunk_location</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geobox</span> <span class="o">=</span> <span class="n">geobox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_affine</span> <span class="o">=</span> <span class="n">parent_affine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="n">geobox</span><span class="o">.</span><span class="n">affine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">geobox</span><span class="o">.</span><span class="n">crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">geobox</span><span class="o">.</span><span class="n">extent</span><span class="o">.</span><span class="n">geom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_shape</span> <span class="o">=</span> <span class="n">parent_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_location</span> <span class="o">=</span> <span class="n">array_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_location</span> <span class="o">=</span> <span class="n">chunk_location</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">GeoChunk</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">GeoChunk</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, chunk_location: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_location</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_build_x_coord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_build_y_coord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">array_location</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="GeoChunk.resize_dim"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.resize_dim">[docs]</a>    <span class="k">def</span> <span class="nf">resize_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize the given dimension in the left and right directions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left : int</span>
<span class="sd">            if negative, the dimension is trimmed by the given value on its</span>
<span class="sd">            left-hand or top side. If positive the dimension is expanded on its</span>
<span class="sd">            left-hand or top side.</span>
<span class="sd">        right : int</span>
<span class="sd">            if negative, the dimension is trimmed by the given value on its</span>
<span class="sd">            right-hand or bottom side. If positive the dimension is expanded on</span>
<span class="sd">            its left-hand or bottom side.</span>
<span class="sd">        dim : int {0, 1}</span>
<span class="sd">            Can be 0 or 1. 0 indicates the y or row dimension. 1 indicates the</span>
<span class="sd">            x or colomn dimension.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GeoChunk</span>
<span class="sd">            The resized GeoChunk.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot resize by a non-integer value: </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">dim</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">dim</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">new_affine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span>
        <span class="k">if</span> <span class="n">left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># translation(col, row) aka translation(xoffset, yoffset)</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">left</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="o">-</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">new_affine</span> <span class="o">*=</span> <span class="n">translation</span>
        <span class="n">new_geobox</span> <span class="o">=</span> <span class="n">GeoBox</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">new_affine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">new_location</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_location</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dim</span><span class="p">:</span>
                <span class="n">nloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>
                <span class="n">new_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nloc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoChunk</span><span class="p">(</span>
            <span class="n">new_shape</span><span class="p">,</span>
            <span class="n">new_geobox</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_affine</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">new_location</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunk_location</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.pad_rows"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.pad_rows">[docs]</a>    <span class="k">def</span> <span class="nf">pad_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad both sides of the chunk in the row dimension.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.pad_cols"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.pad_cols">[docs]</a>    <span class="k">def</span> <span class="nf">pad_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad both sides of the chunk in the column dimension.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.pad"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.pad">[docs]</a>    <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad both sides of the chunk in the x and y directions.</span>

<span class="sd">        The size of the chunk along a given axis will grow by twice the</span>
<span class="sd">        specified number because both sides of the chunk are padded.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">nrows</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_rows</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span><span class="o">.</span><span class="n">pad_cols</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_left"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_left">[docs]</a>    <span class="k">def</span> <span class="nf">trim_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s left most columns by `ncols`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_right"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_right">[docs]</a>    <span class="k">def</span> <span class="nf">trim_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s right most columns by `ncols`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_top"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_top">[docs]</a>    <span class="k">def</span> <span class="nf">trim_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s top rows by `nrows`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">nrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_bottom"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">trim_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s bottom rows by `nrows`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">nrows</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_rows"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_rows">[docs]</a>    <span class="k">def</span> <span class="nf">trim_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s rows on both sides by `nrows`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">nrows</span><span class="p">,</span> <span class="o">-</span><span class="n">nrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim_cols"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim_cols">[docs]</a>    <span class="k">def</span> <span class="nf">trim_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim the chunk&#39;s columns on both sides by `ncols`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">ncols</span><span class="p">,</span> <span class="o">-</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.trim"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.trim">[docs]</a>    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim the chunk&#39;s columns and rows on both sides by `nrows` and `ncols`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">nrows</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_rows</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span><span class="o">.</span><span class="n">trim_cols</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.shift_rows"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.shift_rows">[docs]</a>    <span class="k">def</span> <span class="nf">shift_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift the chunk up or down.</span>

<span class="sd">        Negative values shift the chunk up.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">nrows</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.shift_cols"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.shift_cols">[docs]</a>    <span class="k">def</span> <span class="nf">shift_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift the chunk left or right.</span>

<span class="sd">        Negative values shift the chunk left.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_dim</span><span class="p">(</span><span class="o">-</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunk.shift"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunk.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift the chunk in both row and column dimensions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">nrows</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_rows</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span><span class="o">.</span><span class="n">shift_cols</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GeoChunkArray"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunkArray">[docs]</a><span class="k">class</span> <span class="nc">GeoChunkArray</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geochunks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> <span class="n">geochunks</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">GeoChunk</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeoChunkArray</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GeoChunkArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">_array</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">GeoChunkArray</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">GeoChunkArray</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; (shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span>

<div class="viewcode-block" id="GeoChunkArray.ravel"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunkArray.ravel">[docs]</a>    <span class="k">def</span> <span class="nf">ravel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the array as a flattened list of geochunks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span></div>

<div class="viewcode-block" id="GeoChunkArray.map"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunkArray.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoChunkArray</span><span class="p">(</span><span class="n">new</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoChunkArray.to_numpy"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunkArray.to_numpy">[docs]</a>    <span class="k">def</span> <span class="nf">to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span></div>

<div class="viewcode-block" id="GeoChunkArray.to_dask"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.GeoChunkArray.to_dask">[docs]</a>    <span class="k">def</span> <span class="nf">to_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return as a dask array with chunksize of 1.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_raster"><a class="viewcode-back" href="../../raster_tools.html#raster_tools.raster.get_raster">[docs]</a><span class="k">def</span> <span class="nf">get_raster</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null_to_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Raster</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">src</span>
    <span class="k">elif</span> <span class="n">is_str</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Input must be a Raster or path string. Got </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">src</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">RasterDataError</span><span class="p">,</span> <span class="n">RasterIOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not convert input to Raster: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

    <span class="k">if</span> <span class="n">null_to_nan</span> <span class="ow">and</span> <span class="n">rs</span><span class="o">.</span><span class="n">_masked</span><span class="p">:</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">data</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">promote_dtype_to_float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_dtype</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">new_dtype</span><span class="p">)</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rs</span></div>
</pre></div>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By raster_tools Contributors
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright Notice: This is a work of the U.S. Government and is not subject to  copyright protection in the United States.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>